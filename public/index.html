<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Component Life EM</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
  h1 { text-align: center; color: #333; }
  .menu { margin-bottom: 20px; text-align: center; }
  .menu button { margin: 0 5px; padding: 8px 16px; cursor: pointer; }
  .hidden { display: none; }
  table { width: 100%; border-collapse: collapse; font-size: 12px; background: #fff; }
  th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
  th { background-color: #4CAF50; color: white; cursor: pointer; }
  td.numeric { text-align: right; }
  tr:hover { background-color: #f1f1f1; }
  .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background: rgba(0,0,0,0.5); }
  .modal-content { background: #fff; margin: 10% auto; padding: 20px; border-radius: 5px; width: 400px; }
  .modal-content label { display: block; margin-top: 10px; }
  .modal-content input, .modal-content textarea { width: 100%; padding: 6px; margin-top: 4px; }
  .modal-content button { margin-top: 10px; padding: 6px 12px; cursor: pointer; }
  #progressContainer { margin-top: 10px; background: #ddd; border-radius: 5px; }
  #progressBar { width: 0%; height: 20px; background: #4CAF50; border-radius: 5px; }
</style>
</head>
<body>

<h1>Component Life EM</h1>

<div class="menu">
  <button id="menu1Btn">Monitoring Component</button>
  <button id="menu2Btn">Current SMU (Update Multi)</button>
</div>

<!-- Filter Section -->
<div id="filterSection">
  <input type="text" id="filterEquipment" placeholder="Filter Equipment">
  <input type="text" id="filterComponent" placeholder="Filter Component">
  <button id="filterBtn">Filter</button>
  <button id="clearFilterBtn">Clear</button>
</div>

<!-- Menu 1: Monitoring Component -->
<div id="menu1" class="menuContent">
  <button id="addBtn">Tambah Data</button>
  <table id="componentTable">
    <thead>
      <tr>
        <th data-key="equipment">Equipment</th>
        <th data-key="model">Model</th>
        <th data-key="component">Component</th>
        <th data-key="freq">Freq</th>
        <th data-key="cost">Cost</th>
        <th data-key="changeOut">Change Out</th>
        <th data-key="rating">Rating</th>
        <th data-key="remarks">Remarks</th>
        <th>Picture</th>
        <th data-key="currentSMU">Current SMU</th>
        <th data-key="nextChange">Next Change</th>
        <th data-key="life">Life</th>
        <th data-key="lifePercent">Life %</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="componentBody"></tbody>
  </table>
</div>

<!-- Menu 2: Update SMU Multi -->
<div id="menu2" class="menuContent hidden">
  <h3>Update Current SMU Multi</h3>
  <textarea id="smuTextarea" rows="10" placeholder="CO4402 1234&#10;CO4356 2341"></textarea><br>
  <button id="updateSMUBtn">Update SMU</button>
  <div id="progressContainer"><div id="progressBar"></div></div>
</div>

<!-- Modal Popup for Add/Edit -->
<div id="dataModal" class="modal">
  <div class="modal-content">
    <h3 id="modalTitle">Tambah Data</h3>
    <label>Equipment <input type="text" id="modalEquipment"></label>
    <label>Model <input type="text" id="modalModel"></label>
    <label>Component <input type="text" id="modalComponent"></label>
    <label>Freq <input type="number" id="modalFreq"></label>
    <label>Cost <input type="number" id="modalCost"></label>
    <label>Change Out <input type="number" id="modalChangeOut"></label>
    <label>Rating <input type="text" id="modalRating"></label>
    <label>Remarks <input type="text" id="modalRemarks"></label>
    <label>Picture <input type="file" id="modalPicture"></label>
    <button id="saveModalBtn">Save</button>
    <button id="closeModalBtn">Close</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-storage.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyAHQFyRifcuYJYGuiQaK9vvWJpYGfoDdmI",
  authDomain: "component-life.firebaseapp.com",
  projectId: "component-life",
  storageBucket: "component-life.appspot.com",
  messagingSenderId: "401190574281",
  appId: "1:401190574281:web:16c2401b5bda146779d518",
  measurementId: "G-77WF4LVS25"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

let currentEditId = null;

// Menu Toggle
const menu1Btn = document.getElementById('menu1Btn');
const menu2Btn = document.getElementById('menu2Btn');
const menu1Div = document.getElementById('menu1');
const menu2Div = document.getElementById('menu2');

menu1Btn.onclick = () => { menu1Div.classList.remove('hidden'); menu2Div.classList.add('hidden'); }
menu2Btn.onclick = () => { menu2Div.classList.remove('hidden'); menu1Div.classList.add('hidden'); }

// Modal
const modal = document.getElementById('dataModal');
const modalTitle = document.getElementById('modalTitle');
const modalEquipment = document.getElementById('modalEquipment');
const modalModel = document.getElementById('modalModel');
const modalComponent = document.getElementById('modalComponent');
const modalFreq = document.getElementById('modalFreq');
const modalCost = document.getElementById('modalCost');
const modalChangeOut = document.getElementById('modalChangeOut');
const modalRating = document.getElementById('modalRating');
const modalRemarks = document.getElementById('modalRemarks');
const modalPicture = document.getElementById('modalPicture');
const saveModalBtn = document.getElementById('saveModalBtn');
const closeModalBtn = document.getElementById('closeModalBtn');

document.getElementById('addBtn').onclick = () => {
  currentEditId = null;
  modalTitle.innerText = 'Tambah Data';
  modalEquipment.value = '';
  modalModel.value = '';
  modalComponent.value = '';
  modalFreq.value = '';
  modalCost.value = '';
  modalChangeOut.value = '';
  modalRating.value = '';
  modalRemarks.value = '';
  modalPicture.value = '';
  modal.style.display = 'block';
}

closeModalBtn.onclick = () => modal.style.display = 'none';

// Load Data
async function loadData() {
  const tbody = document.getElementById('componentBody');
  tbody.innerHTML = '';
  const querySnapshot = await getDocs(collection(db, 'componentLife'));
  querySnapshot.forEach(docSnap => {
    const data = docSnap.data();
    const tr = document.createElement('tr');

    const life = data.currentSMU && data.changeOut ? data.currentSMU - data.changeOut : 0;
    const lifePercent = data.freq ? (life / data.freq * 100) : 0;

    tr.innerHTML = `
      <td>${data.equipment || ''}</td>
      <td>${data.model || ''}</td>
      <td>${data.component || ''}</td>
      <td class="numeric">${data.freq?.toLocaleString() || ''}</td>
      <td class="numeric">${data.cost?.toLocaleString() || ''}</td>
      <td class="numeric">${data.changeOut?.toLocaleString() || ''}</td>
      <td>${data.rating || ''}</td>
      <td>${data.remarks || ''}</td>
      <td>${data.picture ? `<img src="${data.picture}" width="50"/>` : ''}</td>
      <td class="numeric">${data.currentSMU?.toLocaleString() || ''}</td>
      <td class="numeric">${data.nextChange?.toLocaleString() || ''}</td>
      <td class="numeric" style="${getLifeStyle(life, data.freq)}">${life.toLocaleString()}</td>
      <td class="numeric" style="${getLifePercentStyle(lifePercent)}">${lifePercent.toFixed(0)}%</td>
      <td>
        <button class="editBtn" data-id="${docSnap.id}">✏️</button>
        <button class="deleteBtn" data-id="${docSnap.id}">❌</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Life Styling
function getLifeStyle(life, freq) {
  if (!freq) return '';
  const perc = life / freq;
  if (perc > 1) return 'background:red;color:white';
  if (perc >= 0.85) return 'background:orange;color:white';
  if (perc >= 0.6) return 'background:blue;color:white';
  if (perc >= 0.5) return 'background:yellow;color:black';
  return '';
}

// Life % Styling
function getLifePercentStyle(lifePercent) {
  if (lifePercent > 100) return 'background:red;color:white';
  if (lifePercent >= 86) return 'background:blue;color:white';
  if (lifePercent >= 76) return 'background:green;color:white';
  if (lifePercent >= 50) return 'background:yellow;color:black';
  return '';
}

// Save Modal
saveModalBtn.onclick = async () => {
  const obj = {
    equipment: modalEquipment.value,
    model: modalModel.value,
    component: modalComponent.value,
    freq: Number(modalFreq.value) || 0,
    cost: Number(modalCost.value) || 0,
    changeOut: Number(modalChangeOut.value) || 0,
    rating: modalRating.value,
    remarks: modalRemarks.value,
    currentSMU: 0,
    nextChange: 0,
    life: 0,
    lifePercent: 0,
    picture: ''
  };

  // Upload picture jika ada
  if (modalPicture.files.length > 0) {
    const file = modalPicture.files[0];
    const storageRef = ref(storage, 'images/' + file.name);
    await uploadBytes(storageRef, file);
    obj.picture = await getDownloadURL(storageRef);
  }

  if (currentEditId) {
    await updateDoc(doc(db, 'componentLife', currentEditId), obj);
  } else {
    await addDoc(collection(db, 'componentLife'), obj);
  }

  modal.style.display = 'none';
  await loadData();
}

// Edit & Delete
document.getElementById('componentBody').addEventListener('click', async e => {
  if (e.target.classList.contains('deleteBtn')) {
    const id = e.target.dataset.id;
    if (confirm('Yakin ingin hapus data?')) {
      await deleteDoc(doc(db, 'componentLife', id));
      await loadData();
    }
  }
  if (e.target.classList.contains('editBtn')) {
    const id = e.target.dataset.id;
    currentEditId = id;
    const docSnap = await getDocs(collection(db, 'componentLife'));
    docSnap.forEach(d => {
      if (d.id === id) {
        const data = d.data();
        modalEquipment.value = data.equipment;
        modalModel.value = data.model;
        modalComponent.value = data.component;
        modalFreq.value = data.freq;
        modalCost.value = data.cost;
        modalChangeOut.value = data.changeOut;
        modalRating.value = data.rating;
        modalRemarks.value = data.remarks;
        modalTitle.innerText = 'Edit Data';
        modal.style.display = 'block';
      }
    });
  }
});

// Filter
document.getElementById('filterBtn').onclick = () => {
  const eq = document.getElementById('filterEquipment').value.toLowerCase();
  const comp = document.getElementById('filterComponent').value.toLowerCase();
  const rows = document.querySelectorAll('#componentBody tr');
  rows.forEach(r => {
    const tEq = r.cells[0].innerText.toLowerCase();
    const tComp = r.cells[2].innerText.toLowerCase();
    r.style.display = (tEq.includes(eq) && tComp.includes(comp)) ? '' : 'none';
  });
}

document.getElementById('clearFilterBtn').onclick = () => {
  document.getElementById('filterEquipment').value = '';
  document.getElementById('filterComponent').value = '';
  document.querySelectorAll('#componentBody tr').forEach(r => r.style.display = '');
}

// Update SMU Multi
document.getElementById('updateSMUBtn').onclick = async () => {
  const lines = document.getElementById('smuTextarea').value.split('\n').filter(l => l.trim() !== '');
  const bar = document.getElementById('progressBar');
  const total = lines.length;
  let count = 0;
  for (let line of lines) {
    const [eq, smu] = line.split(' ');
    const querySnapshot = await getDocs(collection(db, 'componentLife'));
    for (let d of querySnapshot.docs) {
      if (d.data().equipment === eq) {
        await updateDoc(doc(db, 'componentLife', d.id), { currentSMU: Number(smu) });
      }
    }
    count++;
    bar.style.width = ((count/total)*100) + '%';
  }
  alert('Update SMU selesai ✅');
  bar.style.width = '0%';
  await loadData();
}

// Sort
document.querySelectorAll('#componentTable th[data-key]').forEach(th => {
  th.onclick = () => {
    const key = th.dataset.key;
    const tbody = document.getElementById('componentBody');
    const rows = Array.from(tbody.rows);
    rows.sort((a,b) => {
      const valA = a.cells[th.cellIndex].innerText.toLowerCase();
      const valB = b.cells[th.cellIndex].innerText.toLowerCase();
      return valA.localeCompare(valB, undefined, {numeric:true});
    });
    tbody.innerHTML = '';
    rows.forEach(r => tbody.appendChild(r));
  }
});

loadData();
</script>

</body>
</html>
