<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Component Life EM</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:20px; background:#f4f6f9; }
    h1 { text-align:center; color:#2c3e50; }
    nav { text-align:center; margin-bottom:20px; }
    nav button { margin:5px; padding:10px 20px; border:none; border-radius:8px; background:#3498db; color:white; cursor:pointer; }
    nav button:hover { background:#2980b9; }
    table { width:100%; border-collapse:collapse; margin-top:20px; background:white; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    th, td { border:1px solid #ddd; padding:8px; text-align:center; }
    th { background:#2c3e50; color:white; }
    tr:nth-child(even) { background:#f9f9f9; }
    button.action { padding:4px 8px; margin:2px; border:none; border-radius:5px; cursor:pointer; }
    .edit { background:#f39c12; color:white; }
    .save { background:#27ae60; color:white; }
    .delete { background:#e74c3c; color:white; }
    .add-row { background:#2ecc71; color:white; padding:8px 12px; margin-top:10px; border:none; border-radius:8px; cursor:pointer; }
    #menu-smu textarea { width:100%; border-radius:6px; padding:10px; }
  </style>
</head>
<body>

<h1>Component Life EM</h1>

<nav>
  <button onclick="showMenu('menu-monitoring')">Monitoring Component</button>
  <button onclick="showMenu('menu-smu')">Current SMU (Update SMU Multi)</button>
</nav>

<!-- Monitoring Component -->
<div id="menu-monitoring">
  <button class="add-row" onclick="addRow()">+ Tambah Data</button>
  <table id="componentTable">
    <thead>
      <tr>
        <th>Equipment</th>
        <th>Model</th>
        <th>Component</th>
        <th>Freq</th>
        <th>Cost</th>
        <th>Change Out</th>
        <th>Current SMU</th>
        <th>Next Change</th>
        <th>Life</th>
        <th>Life %</th>
        <th>Picture</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="componentBody"></tbody>
  </table>
</div>

<!-- Update SMU Multi -->
<div id="menu-smu" style="display:none;">
  <h2>Update Current SMU (Multi)</h2>
  <textarea id="bulkSMU" rows="8" placeholder="CO4402 1234&#10;CO4356 2341&#10;CO4432 3412"></textarea>
  <br><br>
  <button id="updateSMUMulti">Update All</button>
  <div id="updateStatus"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

  // === Firebase Config ===
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // === Switch Menu ===
  function showMenu(menu) {
    document.getElementById("menu-monitoring").style.display = "none";
    document.getElementById("menu-smu").style.display = "none";
    document.getElementById(menu).style.display = "block";
  }
  window.showMenu = showMenu;

  // === Load Data ===
  async function loadData() {
    const tbody = document.getElementById("componentBody");
    tbody.innerHTML = "";
    const snapshot = await getDocs(collection(db, "componentLife"));
    snapshot.forEach(docu => {
      const d = docu.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${d.equipment || ""}</td>
        <td>${d.model || ""}</td>
        <td>${d.component || ""}</td>
        <td>${d.freq || ""}</td>
        <td>${d.cost || ""}</td>
        <td>${d.changeOut || ""}</td>
        <td>${d.currentSMU || ""}</td>
        <td>${d.nextChange || ""}</td>
        <td>${d.life || ""}</td>
        <td>${d.lifePercent || ""}</td>
        <td>${d.picture ? `<img src="${d.picture}" width="50">` : ""}</td>
        <td>
          <button class="action edit" onclick="editRow('${docu.id}')">Edit</button>
          <button class="action delete" onclick="deleteRow('${docu.id}')">Delete</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }
  loadData();

  // === Add Row ===
  function addRow() {
    const tbody = document.getElementById("componentBody");
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input></td>
      <td><input></td>
      <td><input></td>
      <td><input type="number"></td>
      <td><input type="number"></td>
      <td><input type="number"></td>
      <td><input type="number"></td>
      <td>-</td><td>-</td><td>-</td>
      <td><input type="file"></td>
      <td><button class="action save" onclick="saveNewRow(this)">Save</button></td>`;
    tbody.prepend(tr);
  }
  window.addRow = addRow;

  // === Save New Row ===
  async function saveNewRow(btn) {
    const tr = btn.parentElement.parentElement;
    const inputs = tr.querySelectorAll("input");
    const data = {
      equipment: inputs[0].value || "",
      model: inputs[1].value || "",
      component: inputs[2].value || "",
      freq: parseInt(inputs[3].value) || 0,
      cost: parseFloat(inputs[4].value) || 0,
      changeOut: parseInt(inputs[5].value) || 0,
      currentSMU: parseInt(inputs[6].value) || 0,
    };
    data.nextChange = data.currentSMU + data.freq;
    data.life = data.currentSMU - data.changeOut;
    data.lifePercent = data.freq > 0 ? ((data.life / data.freq) * 100).toFixed(1) : 0;

    await addDoc(collection(db, "componentLife"), data);
    loadData();
  }
  window.saveNewRow = saveNewRow;

  // === Edit Row ===
  async function editRow(id) {
    const q = query(collection(db, "componentLife"), where("__name__", "==", id));
    const snap = await getDocs(q);
    snap.forEach(docu => {
      const d = docu.data();
      const tbody = document.getElementById("componentBody");
      tbody.querySelectorAll("tr").forEach(row => {
        if (row.innerText.includes(d.equipment)) {
          row.innerHTML = `
            <td><input value="${d.equipment}"></td>
            <td><input value="${d.model}"></td>
            <td><input value="${d.component}"></td>
            <td><input type="number" value="${d.freq}"></td>
            <td><input type="number" value="${d.cost}"></td>
            <td><input type="number" value="${d.changeOut}"></td>
            <td><input type="number" value="${d.currentSMU}"></td>
            <td>-</td><td>-</td><td>-</td>
            <td><input type="file"></td>
            <td><button class="action save" onclick="saveEditRow('${id}', this)">Save</button></td>`;
        }
      });
    });
  }
  window.editRow = editRow;

  // === Save Edited Row ===
  async function saveEditRow(id, btn) {
    const tr = btn.parentElement.parentElement;
    const inputs = tr.querySelectorAll("input");
    const data = {
      equipment: inputs[0].value || "",
      model: inputs[1].value || "",
      component: inputs[2].value || "",
      freq: parseInt(inputs[3].value) || 0,
      cost: parseFloat(inputs[4].value) || 0,
      changeOut: parseInt(inputs[5].value) || 0,
      currentSMU: parseInt(inputs[6].value) || 0,
    };
    data.nextChange = data.currentSMU + data.freq;
    data.life = data.currentSMU - data.changeOut;
    data.lifePercent = data.freq > 0 ? ((data.life / data.freq) * 100).toFixed(1) : 0;

    await updateDoc(doc(db, "componentLife", id), data);
    loadData();
  }
  window.saveEditRow = saveEditRow;

  // === Delete Row ===
  async function deleteRow(id) {
    await deleteDoc(doc(db, "componentLife", id));
    loadData();
  }
  window.deleteRow = deleteRow;

  // === Update SMU Multi ===
  document.getElementById("updateSMUMulti").addEventListener("click", async () => {
    const bulkText = document.getElementById("bulkSMU").value.trim();
    const statusDiv = document.getElementById("updateStatus");
    statusDiv.innerHTML = "Processing... ⏳";

    if (!bulkText) {
      statusDiv.innerHTML = "⚠️ Data kosong!";
      return;
    }

    const lines = bulkText.split("\n");
    let success = 0, fail = 0;

    for (let line of lines) {
      const parts = line.trim().split(/\s+/);
      if (parts.length < 2) continue;

      const equipment = parts[0];
      const smu = parseInt(parts[1]);

      try {
        const q = query(collection(db, "componentLife"), where("equipment", "==", equipment));
        const snap = await getDocs(q);

        if (!snap.empty) {
          snap.forEach(async (docu) => {
            await updateDoc(doc(db, "componentLife", docu.id), {
              currentSMU: smu,
              nextChange: smu + (docu.data().freq || 0),
              life: smu - (docu.data().changeOut || 0),
              lifePercent: ((smu - (docu.data().changeOut || 0)) / (docu.data().freq || 1) * 100).toFixed(1)
            });
          });
          success++;
        } else {
          fail++;
        }
      } catch (err) {
        console.error("Gagal update", equipment, err);
        fail++;
      }
    }

    statusDiv.innerHTML = `✅ Sukses update: ${success}, ❌ Gagal: ${fail}`;
  });
</script>
</body>
</html>
