
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAHQFyRifcuYJYGuiQaK9vvWJpYGfoDdmI",
    authDomain: "component-life.firebaseapp.com",
    projectId: "component-life",
    storageBucket: "component-life.appspot.com",
    messagingSenderId: "401190574281",
    appId: "1:401190574281:web:16c2401b5bda146779d518",
    measurementId: "G-77WF4LVS25"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const db = getFirestore(app);

  const currentSMU = { "EX1001": 5000, "EX1002": 6200 };

  function openForm() {
    document.querySelector('.overlay').style.display = 'block';
    document.querySelector('.form-popup').style.display = 'block';
  }

  function closeForm() {
    document.querySelector('.overlay').style.display = 'none';
    document.querySelector('.form-popup').style.display = 'none';
  }

  document.getElementById('addForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const form = e.target;
    const equip = form.equip.value;
    const model = form.model.value;
    const component = form.component.value;
    const freq = parseFloat(form.freq.value);
    const cost = parseFloat(form.cost.value);
    const changeOut = parseFloat(form.changeOut.value);
    const rating = form.rating.value;
    const remarks = form.remarks.value;
    const foto = form.foto.files[0]?.name || '';

    const current = currentSMU[equip] || 0;
    const nextChange = changeOut + freq;
    const life = current - changeOut;
    const lifePercent = ((life / freq) * 100).toFixed(1);

    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${equip}</td><td>${model}</td><td>${component}</td><td>${freq}</td><td>${cost}</td><td>${changeOut}</td>
      <td>${nextChange}</td><td>${current}</td><td>${life}</td><td>${lifePercent}%</td><td>${rating}</td><td>${remarks}</td>
      <td>${foto}</td>
      <td>
        <button class="btn btn-sm btn-warning" onclick="editRow(this)">Edit</button>
        <button class="btn btn-sm btn-success" onclick="saveRow(this)">Save</button>
      </td>
    `;
    document.getElementById('dataTable').appendChild(row);
    closeForm();
    form.reset();

    // Save to Firestore
    const data = {
      equip, model, component, freq, cost, changeOut, nextChange, current, life, lifePercent, rating, remarks, foto,
      timestamp: new Date()
    };
    try {
      await addDoc(collection(db, "component_life"), data);
      console.log("Data berhasil disimpan ke Firestore");
    } catch (error) {
      console.error("Gagal simpan data:", error);
    }
  });

  window.editRow = function(btn) {
    const row = btn.closest('tr');
    [...row.children].forEach((cell, i) => {
      if (i < 13) {
        const val = cell.innerText;
        cell.innerHTML = `<input class="form-control form-control-sm" value="${val.replace('%','')}" />`;
      }
    });
  }

  window.saveRow = function(btn) {
    const row = btn.closest('tr');
    [...row.children].forEach((cell, i) => {
      if (i < 13) {
        const input = cell.querySelector('input');
        if (input) cell.innerText = i === 9 ? `${input.value}%` : input.value;
      }
    });
  }
</script>
