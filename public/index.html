<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Component Life EM</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800">

  <!-- Header -->
  <header class="bg-blue-700 text-white py-4 shadow-lg">
    <h1 class="text-center text-2xl font-bold">üìä Component Life EM</h1>
  </header>

  <!-- Menu -->
  <nav class="flex justify-center space-x-6 bg-blue-100 py-3 shadow">
    <button onclick="showMenu('monitoring')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Monitoring Component</button>
    <button onclick="showMenu('smu')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Current SMU (Update)</button>
  </nav>

  <!-- Monitoring Component -->
  <section id="monitoring" class="p-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold">üìã Monitoring Component</h2>
      <button onclick="openAddForm()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">+ Tambah Data</button>
    </div>

    <div class="overflow-x-auto bg-white rounded-lg shadow-lg">
      <table class="min-w-full border border-gray-300">
        <thead class="bg-gray-200">
          <tr>
            <th class="border px-3 py-2">Equipment</th>
            <th class="border px-3 py-2">Model</th>
            <th class="border px-3 py-2">Component</th>
            <th class="border px-3 py-2">Freq</th>
            <th class="border px-3 py-2">Cost</th>
            <th class="border px-3 py-2">Change Out</th>
            <th class="border px-3 py-2">Current SMU</th>
            <th class="border px-3 py-2">Next Change</th>
            <th class="border px-3 py-2">Life</th>
            <th class="border px-3 py-2">Life %</th>
            <th class="border px-3 py-2">Picture</th>
            <th class="border px-3 py-2">Action</th>
          </tr>
        </thead>
        <tbody id="componentTable" class="text-center"></tbody>
      </table>
    </div>
  </section>

  <!-- Current SMU -->
  <section id="smu" class="p-6 hidden">
    <h2 class="text-xl font-semibold mb-4">‚öôÔ∏è Update Current SMU</h2>
    <form id="smuForm" class="bg-white p-4 rounded-lg shadow-lg space-y-4">
      <div>
        <label class="block font-semibold">Equipment ID</label>
        <input id="smuEquipment" type="text" class="border p-2 w-full rounded-lg">
      </div>
      <div>
        <label class="block font-semibold">Current SMU</label>
        <input id="smuValue" type="number" class="border p-2 w-full rounded-lg">
      </div>
      <button type="button" onclick="updateSMU()" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">Update SMU</button>
    </form>
  </section>

  <!-- Add/Edit Form -->
  <div id="formModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-lg w-96">
      <h3 class="text-lg font-semibold mb-4">Tambah / Edit Component</h3>
      <form id="componentForm" class="space-y-3">
        <input type="hidden" id="docId">
        <input id="equipment" placeholder="Equipment" class="border p-2 w-full rounded-lg">
        <input id="model" placeholder="Model" class="border p-2 w-full rounded-lg">
        <input id="component" placeholder="Component" class="border p-2 w-full rounded-lg">
        <input id="freq" placeholder="Freq" type="number" class="border p-2 w-full rounded-lg">
        <input id="cost" placeholder="Cost" type="number" class="border p-2 w-full rounded-lg">
        <input id="changeOut" placeholder="Change Out" type="number" class="border p-2 w-full rounded-lg">
        <label class="block">Picture:</label>
        <input id="picture" type="file" accept="image/*" class="w-full">
        <button type="button" onclick="saveComponent()" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Save</button>
        <button type="button" onclick="closeForm()" class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">Cancel</button>
      </form>
    </div>
  </div>

  <!-- JS -->
  <script>
    // === Firebase Config (ganti dengan projectmu) ===
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    // === Toggle Menu ===
    function showMenu(menu) {
      document.getElementById("monitoring").classList.add("hidden");
      document.getElementById("smu").classList.add("hidden");
      document.getElementById(menu).classList.remove("hidden");
    }

    // === Modal ===
    function openAddForm() {
      document.getElementById("formModal").classList.remove("hidden");
      document.getElementById("componentForm").reset();
      document.getElementById("docId").value = "";
    }
    function closeForm() {
      document.getElementById("formModal").classList.add("hidden");
    }

    // === Save Component ===
    async function saveComponent() {
      const docId = document.getElementById("docId").value;
      const equipment = document.getElementById("equipment").value;
      const model = document.getElementById("model").value;
      const component = document.getElementById("component").value;
      const freq = parseInt(document.getElementById("freq").value) || 0;
      const cost = parseInt(document.getElementById("cost").value) || 0;
      const changeOut = parseInt(document.getElementById("changeOut").value) || 0;
      const file = document.getElementById("picture").files[0];

      let pictureUrl = "";
      if (file) {
        const storageRef = storage.ref("pictures/" + file.name);
        await storageRef.put(file);
        pictureUrl = await storageRef.getDownloadURL();
      }

      const data = { equipment, model, component, freq, cost, changeOut, picture: pictureUrl };

      if (docId) {
        await db.collection("components").doc(docId).update(data);
      } else {
        await db.collection("components").add(data);
      }

      closeForm();
      loadComponents();
    }

    // === Load Components ===
    async function loadComponents() {
      const snapshot = await db.collection("components").get();
      const table = document.getElementById("componentTable");
      table.innerHTML = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        const currentSMU = data.currentSMU || 0;
        const nextChange = currentSMU + (data.freq || 0);
        const life = currentSMU - (data.changeOut || 0);
        const lifePct = data.freq ? ((life / data.freq) * 100).toFixed(1) : 0;

        table.innerHTML += `
          <tr>
            <td class="border px-3 py-2">${data.equipment}</td>
            <td class="border px-3 py-2">${data.model}</td>
            <td class="border px-3 py-2">${data.component}</td>
            <td class="border px-3 py-2">${data.freq}</td>
            <td class="border px-3 py-2">${data.cost}</td>
            <td class="border px-3 py-2">${data.changeOut}</td>
            <td class="border px-3 py-2">${currentSMU}</td>
            <td class="border px-3 py-2">${nextChange}</td>
            <td class="border px-3 py-2">${life}</td>
            <td class="border px-3 py-2">${lifePct}%</td>
            <td class="border px-3 py-2">
              ${data.picture ? `<img src="${data.picture}" class="h-12 mx-auto">` : "-"}
            </td>
            <td class="border px-3 py-2 space-x-2">
              <button onclick="editComponent('${doc.id}')" class="bg-yellow-500 text-white px-2 py-1 rounded">Edit</button>
              <button onclick="deleteComponent('${doc.id}')" class="bg-red-600 text-white px-2 py-1 rounded">Delete</button>
            </td>
          </tr>
        `;
      });
    }

    // === Edit Component ===
    async function editComponent(id) {
      const docSnap = await db.collection("components").doc(id).get();
      const data = docSnap.data();
      document.getElementById("docId").value = id;
      document.getElementById("equipment").value = data.equipment;
      document.getElementById("model").value = data.model;
      document.getElementById("component").value = data.component;
      document.getElementById("freq").value = data.freq;
      document.getElementById("cost").value = data.cost;
      document.getElementById("changeOut").value = data.changeOut;
      document.getElementById("formModal").classList.remove("hidden");
    }

    // === Delete Component ===
    async function deleteComponent(id) {
      if (confirm("Yakin hapus data ini?")) {
        await db.collection("components").doc(id).delete();
        loadComponents();
      }
    }

    // === Update SMU ===
    async function updateSMU() {
      const equipment = document.getElementById("smuEquipment").value;
      const smuValue = parseInt(document.getElementById("smuValue").value) || 0;

      const snapshot = await db.collection("components").where("equipment", "==", equipment).get();
      snapshot.forEach(async doc => {
        await db.collection("components").doc(doc.id).update({ currentSMU: smuValue });
      });

      alert("SMU berhasil diupdate ‚úÖ");
      loadComponents();
    }

    // === Init Load ===
    loadComponents();
  </script>
</body>
</html>
