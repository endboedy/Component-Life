
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Component Life EM</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js"></script>
</head>
<body class="container py-4">
  <h2>Component Life EM</h2>

  <!-- Tabs -->
  <ul class="nav nav-tabs" id="mainTabs">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#compLife">Comp-Life</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#updateSMU">Update Current SMU</a></li>
  </ul>

  <div class="tab-content">
    <!-- Comp-Life Tab -->
    <div class="tab-pane fade show active" id="compLife">
      <div class="input-bar d-flex flex-wrap gap-2 mt-3">
        <input class="form-control" id="equip" placeholder="Equip" />
        <input class="form-control" id="model" placeholder="Model" />
        <input class="form-control" id="component" placeholder="Component" />
        <button class="btn btn-primary" onclick="openForm()">Add New</button>
      </div>
      <table class="table table-bordered table-striped mt-3">
        <thead>
          <tr>
            <th>Equip</th><th>Model</th><th>Component</th><th>Freq</th><th>Cost</th><th>Change Out</th>
            <th>Next Change</th><th>Current SMU</th><th>Life</th><th>Life %</th><th>Rating</th><th>Remarks</th><th>Foto</th><th>Action</th>
          </tr>
        </thead>
        <tbody id="dataTable"></tbody>
      </table>
    </div>

    <!-- Update Current SMU Tab -->
    <div class="tab-pane fade" id="updateSMU">
      <h5 class="mt-3">Update Current SMU (Massal)</h5>
      <textarea id="inputSMU" class="form-control mb-3" rows="5" placeholder="Contoh:
C02060	17506
C02072	67719"></textarea>
      <div class="mb-3">
        <button class="btn btn-primary" onclick="tampilkanTabel()">Tampilkan Tabel</button>
        <button class="btn btn-success" onclick="updateFirebaseSMU()">Update Semua ke Firebase</button>
      </div>
      <table class="table table-bordered table-smu">
        <thead><tr><th>Equipment</th><th>Current SMU</th></tr></thead>
        <tbody id="smuTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Form Popup -->
  <div class="modal fade" id="formModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <form class="modal-content" id="addForm">
        <div class="modal-header"><h5 class="modal-title">Add New Component</h5></div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6"><input class="form-control mb-2" name="freq" type="number" placeholder="Freq" required /></div>
            <div class="col-md-6"><input class="form-control mb-2" name="cost" type="number" placeholder="Cost" required /></div>
            <div class="col-md-6"><input class="form-control mb-2" name="changeOut" type="number" placeholder="Change Out" required /></div>
            <div class="col-md-6"><input class="form-control mb-2" name="rating" placeholder="Rating" /></div>
            <div class="col-md-12"><input class="form-control mb-2" name="remarks" placeholder="Remarks" /></div>
            <div class="col-md-12"><input class="form-control mb-2" name="foto" type="file" accept="image/*" /></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Save</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Firebase config placeholder
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentSMU = {};

    // Load Current SMU from Firebase
    function loadCurrentSMU() {
      db.collection("current_smu").get().then(snapshot => {
        snapshot.forEach(doc => {
          currentSMU[doc.id] = doc.data().smu;
        });
      });
    }

    loadCurrentSMU();

    function openForm() {
      new bootstrap.Modal(document.getElementById('formModal')).show();
    }

    document.getElementById('addForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const equip = document.getElementById('equip').value;
      const model = document.getElementById('model').value;
      const component = document.getElementById('component').value;
      const form = e.target;
      const freq = parseFloat(form.freq.value);
      const cost = parseFloat(form.cost.value);
      const changeOut = parseFloat(form.changeOut.value);
      const rating = form.rating.value;
      const remarks = form.remarks.value;
      const foto = form.foto.files[0]?.name || '';

      const current = currentSMU[equip] || 0;
      const nextChange = changeOut + freq;
      const life = current - changeOut;
      const lifePercent = ((life / freq) * 100).toFixed(1);

      const data = {
        equip, model, component, freq, cost, changeOut, nextChange,
        currentSMU: current, life, lifePercent, rating, remarks, foto
      };

      db.collection("component_life").add(data).then(() => {
        const row = `<tr>
          <td>${equip}</td><td>${model}</td><td>${component}</td><td>${freq}</td><td>${cost}</td><td>${changeOut}</td>
          <td>${nextChange}</td><td>${current}</td><td>${life}</td><td>${lifePercent}%</td><td>${rating}</td><td>${remarks}</td>
          <td>${foto}</td>
          <td><button class="btn btn-sm btn-warning">Edit</button> <button class="btn btn-sm btn-success">Save</button></td>
        </tr>`;
        document.getElementById('dataTable').insertAdjacentHTML('beforeend', row);
        bootstrap.Modal.getInstance(document.getElementById('formModal')).hide();
        form.reset();
      });
    });

    let smuData = [];

    function tampilkanTabel() {
      const input = document.getElementById('inputSMU').value.trim();
      const lines = input.split('\n');
      const tbody = document.getElementById('smuTableBody');
      tbody.innerHTML = '';
      smuData = [];

      lines.forEach(line => {
        const [equip, smu] = line.split('\t');
        if (equip && smu && !isNaN(smu)) {
          smuData.push({ equip: equip.trim(), smu: parseInt(smu.trim()) });
          const row = `<tr><td>${equip.trim()}</td><td>${smu.trim()}</td></tr>`;
          tbody.insertAdjacentHTML('beforeend', row);
        }
      });
    }

    function updateFirebaseSMU() {
      smuData.forEach(item => {
        db.collection("current_smu").doc(item.equip).set({ smu: item.smu });
      });
      alert("Data SMU berhasil diupdate ke Firebase.");
      loadCurrentSMU();
    }
  </script>
</body>
</html>
